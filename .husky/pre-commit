#!/bin/sh

# Quality Gates Pre-Commit Hook
# Runs essential quality checks before allowing commit

echo "ğŸ” Running Quality Gates Pre-Commit Checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No staged files to check"
    exit 0
fi

echo "ğŸ“ Checking $(echo "$STAGED_FILES" | wc -l) staged files..."

# Check if there are TypeScript/JavaScript files
TS_JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)

# Always run TypeScript compilation if there are any relevant files
echo "ğŸ”§ TypeScript compilation..."
if ! npm run type-check > /dev/null 2>&1; then
    echo "âŒ TypeScript compilation failed"
    echo "Run 'npm run type-check' to see details"
    exit 1
fi

# Run ESLint only if there are TS/JS files
if [ -n "$TS_JS_FILES" ]; then
    echo "ğŸ§¹ ESLint check..."
    if ! npx eslint $TS_JS_FILES --max-warnings 0 --quiet --no-warn-ignored; then
        echo "âŒ ESLint found issues"
        echo "Run 'npm run lint:fix' to auto-fix issues"
        exit 1
    fi

    echo "ğŸ’… Prettier check..."
    if ! npx prettier --check $TS_JS_FILES > /dev/null 2>&1; then
        echo "âŒ Code formatting issues found"
        echo "Run 'npm run format' to fix formatting"
        exit 1
    fi
else
    echo "ğŸ§¹ ESLint check: âœ… No TS/JS files to check"
    echo "ğŸ’… Prettier check: âœ… No TS/JS files to check"
fi

# Always run tests
echo "ğŸ§ª Running tests..."
if ! npm run test:run --silent > /dev/null 2>&1; then
    echo "âŒ Tests failed"
    echo "Run 'npm run test' to see details"
    exit 1
fi

# Quick build check (only if src files changed)
SRC_CHANGED=$(echo "$STAGED_FILES" | grep "^src/" | wc -l)
if [ "$SRC_CHANGED" -gt 0 ]; then
    echo "ğŸ—ï¸  Quick build verification..."
    if ! npm run build > /dev/null 2>&1; then
        echo "âŒ Build failed"
        echo "Run 'npm run build' to see details"
        exit 1
    fi
    echo "   - Build: âœ… Build successful"
else
    echo "ğŸ—ï¸  Build check: âœ… No src files changed"
fi

echo "âœ… All pre-commit quality gates passed!"
echo "ğŸ“Š Quality summary:"
echo "   - TypeScript: âœ… No compilation errors"
if [ -n "$TS_JS_FILES" ]; then
    echo "   - ESLint: âœ… No linting issues"
    echo "   - Prettier: âœ… Code properly formatted"
else
    echo "   - ESLint: âœ… No TS/JS files to check"
    echo "   - Prettier: âœ… No TS/JS files to check"
fi
echo "   - Tests: âœ… All tests passing"

exit 0
